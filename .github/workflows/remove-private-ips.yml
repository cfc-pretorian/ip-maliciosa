name: Remover IPs privadas de la lista

on:
  schedule:
    # Una vez a la semana: domingos a las 03:00 UTC
    - cron: '0 3 * * 0'
  workflow_dispatch: {}

jobs:
  remove-private-ips:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Ejecutar limpieza de IPs privadas
        run: |
          python .github/scripts/remove_private_ips.py malignas.txt

      - name: Verificar si se encontraron IPs privadas
        id: check-private
        run: |
          if [ -s private_ips_found.txt ]; then
            echo "found=true" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit de cambios (si hubo limpieza)
        if: steps.check-private.outputs.found == 'true'
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "actions@github.com"
          git add malignas.txt malignas.txt.private.bak private_ips_found.txt
          git commit -m "Auto-clean semanal: eliminación de IPs privadas"
          git push

      - name: Crear Issue con el listado de IPs privadas
        if: steps.check-private.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('private_ips_found.txt', 'utf8');

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `IPs privadas detectadas en malignas.txt`,
              body: `Se encontraron las siguientes IPs privadas en 'malignas.txt' y fueron eliminadas automáticamente:\n\n` + body
            });
